FROM ghcr.io/astral-sh/uv:python3.13-alpine AS builder

ENV UV_COMPILE_BYTECODE=1 UV_LINK_MODE=copy

WORKDIR /jacobson

COPY pyproject.toml /jacobson
COPY uv.lock /jacobson

RUN uv sync --frozen --no-editable --no-dev --extra docs

# Final Image
FROM docker.io/library/python:3.13-alpine

WORKDIR /jacobson

COPY --from=builder /jacobson/.venv /jacobson/.venv

VOLUME ./jacobson:/jacobson/jacobson
VOLUME ./documentation/site:/jacobson/documentation/site

EXPOSE 8000

ENV PATH="/jacobson/.venv/bin:$PATH"

COPY alembic.ini /jacobson

ENTRYPOINT ["sh", "-c", "alembic upgrade head && uvicorn jacobson.api.app:app --host=0.0.0.0 --reload"]
